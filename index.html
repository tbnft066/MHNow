<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒ¢ãƒ³ãƒãƒ³Now ã‚¹ã‚­ãƒ«ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0d0d0d; --panel:#171717; --card:#1f1f1f;
    --text:#ffffff; --muted:#bfbfbf; --accent:#ffd45e; --accent2:#ffb347; --border:#2a2a2a;
    --hilite:#ffe27a; --skill:#e6e6e6; --drift:#a7dcff;
    --green:#2ecc71; --purple:#bb86fc; --off:#555; --blue:#4da3ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    height:100vh; display:grid; grid-template-columns:460px 1fr;
  }
  /* å·¦ãƒ‘ãƒãƒ« */
  .left{
    background:var(--panel); border-right:1px solid var(--border);
    padding:18px; overflow:auto;
  }
  .title{color:var(--accent); font-size:20px; font-weight:700; margin-bottom:12px}
  .tabs{display:flex; gap:8px; margin-bottom:14px}
  .tab{
    padding:8px 12px; border:1px solid var(--border); border-radius:10px;
    background:#101010; color:#ddd; cursor:pointer; font-weight:700; font-size:14px;
  }
  .tab.active{background:var(--accent); color:#111; border-color:#cdbf65}

  .group{margin-bottom:16px}
  label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
  input, select, button{
    width:100%; border:1px solid var(--border); background:#101010; color:#fff;
    border-radius:8px; padding:9px 10px; font-size:14px;
  }
  input:disabled{opacity:.55; cursor:not-allowed}
  button{background:var(--accent); color:#111; border:none; font-weight:700; cursor:pointer}
  button:hover{filter:brightness(1.05)}
  .rows{display:grid; grid-template-columns:1fr 84px; gap:8px}
  .status{font-size:12px; color:var(--muted); white-space:pre-line; margin-top:6px}

  /* ==== ä¸¸ãƒãƒ–é¢¨ãƒˆã‚°ãƒ« ==== */
  .toggles {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 10px;
  }
  .toggle-block {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* ä¸¸ãƒãƒ–æœ¬ä½“ */
  .dot {
    width: 42px;
    height: 22px;
    border-radius: 999px;
    background: var(--off);
    border: 2px solid var(--border);
    position: relative;
    cursor: pointer;
    transition: background 0.25s, border-color 0.25s;
  }
  .dot::before {
    content: "";
    position: absolute;
    top: 2px;
    left: 2px;
    width: 16px;
    height: 16px;
    background: #ccc;
    border-radius: 50%;
    transition: left 0.25s, background 0.25s;
  }

  /* ONæ™‚ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆè‰²ã”ã¨ã«é•ã†ï¼‰ */
  .dot.green.on { background: var(--green); border-color: var(--green); }
  .dot.green.on::before { left: 22px; background: #fff; }

  .dot.purple.on { background: var(--purple); border-color: var(--purple); }
  .dot.purple.on::before { left: 22px; background: #fff; }

  .dot.blue.on { background: var(--blue); border-color: var(--blue); }
  .dot.blue.on::before { left: 22px; background: #fff; }

  /* OFFæ™‚ */
  .dot.off { background: var(--off); border-color: var(--border); }
  .dot.off::before { left: 2px; background: #888; }

  .hint { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* å³ãƒ‘ãƒãƒ«ï¼‹ã‚«ãƒ¼ãƒ‰ */
  .right{padding:18px; overflow:auto}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(420px,1fr)); gap:16px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px 14px;
    box-shadow:0 0 10px rgba(0,0,0,0.35);
  }
  .card h3{margin:0 0 8px 0; color:var(--accent2); font-size:16px}
  .equip{white-space:pre-wrap; line-height:1.5; color:#eaeaea; margin:0 0 8px 0}
  .hr{height:1px; background:var(--border); margin:8px 0}
  .sumAll{display:flex; flex-wrap:wrap; gap:8px 12px; margin:0; padding:0}
  
  .badge{
    list-style:none; border:1px solid var(--border); border-radius:999px;
    padding:2px 8px; font-size:12px; color:var(--skill); background:#141414;
    white-space:nowrap;
  }
  .badge.hilite{color:#111; background:var(--hilite); border-color:#cdbf65}
  .drifts{color:var(--drift); font-size:12px; margin-top:6px}

  /* å³ä¸Šå›ºå®šã®é€²æ—è¡¨ç¤º */
  .progressFloating{
    position:fixed; top:12px; right:16px;
    background:#000a; backdrop-filter: blur(4px);
    border:1px solid var(--border); border-radius:10px;
    padding:8px 12px; font-size:12px; color:var(--muted); z-index:9999;
    pointer-events:none;
  }

  /* ä¸€è¦§ã‚¿ãƒ–ã®ãƒ†ãƒ¼ãƒ–ãƒ« */
  .list-controls{display:flex; gap:8px; position:sticky; top:0; background:var(--panel); padding-bottom:8px; z-index:2; align-items:center}
  .tableWrap{border:1px solid var(--border); border-radius:12px; overflow:auto; max-height:calc(100vh - 200px)}
  table{width:100%; border-collapse:collapse; font-size:13px}
  thead{background:#141414; z-index:1}
  th, td{border-bottom:1px solid var(--border); padding:8px 10px; vertical-align:top}
  th{color:#ddd; text-align:left}
  td{color:#eee}
  .td-skills{color:#ddd}
  .muted{color:#aaa; font-size:12px}
  /* â˜… ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®š */
  .sticky-header thead th{
    position: sticky;
    top: 0;
    background: #141414;
  }

  @media (max-width: 768px) {
    body {
      display: block;
      height: auto;
    }
    .left {
      width: 100%;
      border-right: none;
    }
    .right {
      display: none; /* å³ãƒ‘ãƒãƒ«ã‚’éš ã™ */
    }
    #resultsSim {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }
  }
</style>
</head>
<body>
  <aside class="left">
    <div class="title">ãƒ¢ãƒ³ãƒãƒ³Now ã‚¹ã‚­ãƒ«ã‚·ãƒ¥ãƒŸãƒ¬ãƒ¼ã‚¿ãƒ¼</div>

    <!-- ã‚¿ãƒ– -->
    <div class="tabs">
      <button class="tab active" id="tab-sim">ã‚¹ã‚­ãƒ«ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</button>
      <button class="tab" id="tab-list">é˜²å…·ã‚¹ã‚­ãƒ«ä¸€è¦§</button>
    </div>

    <!-- CSVèª­ã¿è¾¼ã¿ -->
    <div class="group">
      <label>CSVã‚’èª­ã¿è¾¼ã‚€ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å¿…é ˆ / UTF-8ï¼‰</label>
      <input type="file" id="csv" accept=".csv" />
      <div id="status" class="status">æœªèª­è¾¼</div>
    </div>

    <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼è¨­å®š -->
    <div id="panel-sim">
      <div class="group">
        <div class="toggles">
          <div class="toggle-block">
            <div class="dot green off" id="toggleRock" title="ãƒ­ãƒƒã‚¯ã‚ªãƒ³ ON/OFF" aria-label="ãƒ­ãƒƒã‚¯ã‚ªãƒ³"></div>
            <span class="hint">ãƒ­ãƒƒã‚¯ã‚ªãƒ³</span>
          </div>
          <div class="toggle-block">
            <div class="dot purple off" id="toggleDrift" title="æ¼‚ç§»éŒ¬æˆ ON/OFF" aria-label="æ¼‚ç§»éŒ¬æˆ"></div>
            <span class="hint">æ¼‚ç§»éŒ¬æˆ</span>
          </div>
        </div>
      </div>

      <div class="group">
        <label>ã‚¹ã‚­ãƒ«æ¡ä»¶ï¼ˆæœ€å¤§8å€‹ï¼‰ â€»Lv1ã€œ5ï¼Lvç©ºæ¬„ã¯æ¡ä»¶ã‹ã‚‰é™¤å¤–</label>
        <div class="rows" id="rows"></div>
      </div>

      <div class="group">
        <button id="search">æ¤œç´¢</button>
        <button id="reset" style="margin-top:6px; background:#555; color:#fff;">ãƒªã‚»ãƒƒãƒˆ</button>
        <div id="progress" class="status"></div>
      </div>
    </div>

    <!-- ä¸€è¦§ã‚¿ãƒ–ã®æ“ä½œ -->
    <div id="panel-list" style="display:none;">
      <div class="group">
        <label>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <div class="list-controls">
          <select id="flt-part">
            <option value="">éƒ¨ä½ï¼šã™ã¹ã¦</option>
            <option>é ­</option>
            <option>èƒ´</option>
            <option>è…•</option>
            <option>è…°</option>
            <option>è„š</option>
          </select>
          <input id="flt-skill" placeholder="ã‚¹ã‚­ãƒ«åã§æ¤œç´¢ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼é€šå¸¸ãƒ»éŒ¬æˆï¼‰" />
        </div>

        <!-- ã€ŒéŒ¬æˆã®ã¿ã€ãƒˆã‚°ãƒ« -->
        <div class="toggle-block" title="éŒ¬æˆã‚¹ã‚­ãƒ«ã ã‘è¡¨ç¤º" style="margin-top: 10px;">
          <div class="dot blue off" id="toggleListDrift" aria-label="éŒ¬æˆãƒ•ã‚£ãƒ«ã‚¿"></div>
          <span class="hint">éŒ¬æˆã®ã¿</span>
        </div>
      </div>
    </div>
  </aside>

  <main class="right">
    <!-- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿çµæœ -->
    <div id="resultsSim" class="grid"></div>

    <!-- ä¸€è¦§ è¡¨ -->
    <div id="resultsList" style="display:none;">
      <div class="tableWrap">
        <table id="armorTable" class="sticky-header">
          <thead>
            <tr>
              <th style="width:60px;">éƒ¨ä½</th>
              <th style="width:170px;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</th>
              <th style="width:200px;">é˜²å…·å</th>
              <th>é€šå¸¸ã‚¹ã‚­ãƒ«</th>
              <th>éŒ¬æˆã‚¹ã‚­ãƒ«</th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
      <div class="muted" id="listCount" style="margin-top:6px;"></div>
    </div>
  </main>

  <!-- å³ä¸Šå›ºå®šã®é€²æ—ï¼… -->
  <div id="progressFloating" class="progressFloating" style="display:none;">æ¢ç´¢å¾…æ©Ÿä¸­â€¦</div>

<script>

// ====== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«CSVã‚’è‡ªå‹•èª­è¾¼ ======
window.addEventListener('DOMContentLoaded', () => {
  fetch('ã‚¹ã‚­ãƒ«ä¸€è¦§251028.csv')
    .then(res => res.text())
    .then(text => {
      parseCSV(text);
      statusEl.textContent = `åˆæœŸãƒ‡ãƒ¼ã‚¿èª­è¾¼å®Œäº†ï¼š${armors.length}ä»¶ï¼ˆã‚¹ã‚­ãƒ«å€™è£œ ${skillSet.size}ï¼‰`;
    })
    .catch(err => {
      console.error('åˆæœŸCSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
      statusEl.textContent = "åˆæœŸCSVèª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    });
});


/* ====== ãƒ‡ãƒ¼ã‚¿æ§‹é€  ====== */
const PARTS = ["é ­","èƒ´","è…•","è…°","è„š"];
let armors = []; // {part, monster, name, normal:[{name,lv}], drift:[string]}
let skillSet = new Set();

/* ====== ãƒˆã‚°ãƒ«çŠ¶æ…‹ ====== */
let rockOnEnabled = false; // ãƒ­ãƒƒã‚¯ã‚ªãƒ³ï¼ˆç·‘ï¼‰
let driftEnabled  = false; // æ¼‚ç§»éŒ¬æˆï¼ˆç´«ï¼‰
let listDriftOnly = false; // ä¸€è¦§ã‚¿ãƒ– éŒ¬æˆã®ã¿

/* ====== è¦ç´ å‚ç…§ ====== */
const statusEl = document.getElementById('status');
const resultsSim = document.getElementById('resultsSim');
const resultsList = document.getElementById('resultsList');
const panelSim = document.getElementById('panel-sim');
const panelList = document.getElementById('panel-list');
const tabSim = document.getElementById('tab-sim');
const tabList = document.getElementById('tab-list');

/* ====== ã‚¿ãƒ–åˆ‡æ›¿ ====== */
tabSim.addEventListener('click', ()=>{
  tabSim.classList.add('active'); tabList.classList.remove('active');
  panelSim.style.display='block'; panelList.style.display='none';
  resultsSim.style.display='grid'; resultsList.style.display='none';
});
tabList.addEventListener('click', ()=>{
  tabList.classList.add('active'); tabSim.classList.remove('active');
  panelList.style.display='block'; panelSim.style.display='none';
  resultsList.style.display='block'; resultsSim.style.display='none';
});

/* ====== ãƒˆã‚°ãƒ«æ“ä½œ ====== */
const toggleRock  = document.getElementById('toggleRock');
const toggleDrift = document.getElementById('toggleDrift');
const toggleListDrift = document.getElementById('toggleListDrift');

toggleRock.addEventListener('click', ()=>{
  rockOnEnabled = !rockOnEnabled;
  toggleRock.classList.toggle('on', rockOnEnabled);
  toggleRock.classList.toggle('off', !rockOnEnabled);
});
toggleDrift.addEventListener('click', ()=>{
  driftEnabled = !driftEnabled;
  toggleDrift.classList.toggle('on', driftEnabled);
  toggleDrift.classList.toggle('off', !driftEnabled);
});
toggleListDrift.addEventListener('click', ()=>{
  listDriftOnly = !listDriftOnly;
  toggleListDrift.classList.toggle('on', listDriftOnly);
  toggleListDrift.classList.toggle('off', !listDriftOnly);
  buildListTable(); // å†æç”»
});

/* ====== CSVã‚’ãƒšãƒ¼ã‚¸ä¸Šã§èª­ã¿è¾¼ã‚€ ====== */
document.getElementById('csv').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try{
      parseCSV(ev.target.result);
      statusEl.textContent = `CSVèª­ã¿è¾¼ã¿å®Œäº†ï¼š${armors.length}ä»¶ï¼ˆã‚¹ã‚­ãƒ«å€™è£œ ${skillSet.size}ï¼‰`;
    }catch(err){
      console.error(err);
      statusEl.textContent = "CSVè§£æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
    }
  };
  reader.readAsText(f, 'utf-8');
});

/* ====== CSVè§£æ ====== */
function parseCSV(text){
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(Boolean);
  const rows = lines.map(line => line.split(",").map(c=>c.trim()));
  armors = []; skillSet = new Set();

  // 0:éƒ¨ä½, 1:ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åç§°, 2:é˜²å…·åç§°,
  // 3:ã‚¹ã‚­ãƒ«1,4:ã‚¹ã‚­ãƒ«1Lv, 5:ã‚¹ã‚­ãƒ«2,6:ã‚¹ã‚­ãƒ«2Lv, 7:ã‚¹ã‚­ãƒ«3,8:ã‚¹ã‚­ãƒ«3Lv,
  // 9..18: éŒ¬æˆ1..10 (Lvåˆ—ãªã— â†’ 1å›ºå®š)
  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(r.length<3) continue;
    const part = r[0], monster = r[1], name = r[2];
    if(!part || !name) continue;

    const normal = [];
    for(let k=0;k<3;k++){
      const s  = r[3 + k*2];
      const lv = parseInt(r[4 + k*2],10);
      if(s && !isNaN(lv) && lv>0){
        normal.push({name:s, lv});
        skillSet.add(s);
      }
    }
    const drift = [];
    for(let j=0;j<10;j++){
      const ds = r[9 + j];
      if(ds){
        drift.push(ds);
        skillSet.add(ds);
      }
    }
    armors.push({part, monster, name, normal, drift});
  }

  buildSkillInputs([...skillSet].sort());
  buildListTable(); // ä¸€è¦§ã‚¿ãƒ–åˆæœŸæç”»
}

/* ====== ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿å…¥åŠ›UIï¼ˆ8æ ã€Lvã¯ã‚¹ã‚­ãƒ«åãŒç©ºãªã‚‰ç„¡åŠ¹ï¼‰ ====== */
function buildSkillInputs(skillList){
  const rows = document.getElementById('rows');
  rows.innerHTML = "";
  const dlId="skills";
  let old = document.getElementById(dlId); if(old) old.remove();
  const dl = document.createElement('datalist'); dl.id = dlId;
  skillList.forEach(s=>{ const o=document.createElement('option'); o.value=s; dl.appendChild(o); });
  document.body.appendChild(dl);

  for(let i=0;i<8;i++){
    const name = document.createElement('input');
    name.type="text"; name.placeholder="ã‚¹ã‚­ãƒ«å"; name.setAttribute("list", dlId); name.id=`s_${i}`;
    const lv = document.createElement('input');
    lv.type="number"; lv.min="1"; lv.max="5"; lv.placeholder="Lv"; lv.id=`lv_${i}`;
    lv.disabled = true;

    const syncDisable = ()=>{
      const has = (name.value || "").trim().length > 0;
      lv.disabled = !has;
      if(!has) lv.value = "";
    };
    name.addEventListener('input', syncDisable);
    name.addEventListener('change', syncDisable);

    rows.appendChild(name); rows.appendChild(lv);
  }

  // ã‚¯ãƒªãƒƒã‚¯äºŒé‡ç™»éŒ²ã‚’é¿ã‘ã‚‹ãŸã‚ä¸€æ—¦æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’ç½®æ›
  const newBtn = document.getElementById('search').cloneNode(true);
  document.getElementById('search').replaceWith(newBtn);
  newBtn.id = 'search';
  newBtn.addEventListener('click', runSearch);
}

/* ====== ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³å‡¦ç† ====== */
document.getElementById('reset').addEventListener('click', ()=>{
  for(let i=0;i<8;i++){
    const sEl = document.getElementById(`s_${i}`);
    const lEl = document.getElementById(`lv_${i}`);
    if(sEl) sEl.value = "";
    if(lEl){
      lEl.value = "";
      lEl.disabled = true;
    }
  }
  document.getElementById('progress').textContent = "";
  document.getElementById('resultsSim').innerHTML = "";
});

/* ====== æ¤œç´¢æœ¬ä½“ï¼ˆå®Œå…¨å¯¾å¿œç‰ˆï¼‰ ====== */
function runSearch(){
  // ã‚¹ãƒãƒ›ï¼ˆå¹…768pxä»¥ä¸‹ï¼‰ã®å ´åˆã¯å·¦ãƒ‘ãƒãƒ«å†…ã«çµæœã‚’å‡ºã™
const resultsBox = window.innerWidth <= 768
  ? (() => {
      let area = document.getElementById("mobileResults");
      if (!area) {
        area = document.createElement("div");
        area.id = "mobileResults";
        area.className = "grid";
        const ref = document.getElementById("search").parentNode;
        ref.parentNode.insertBefore(area, ref.nextSibling);
      }
      return area;
    })()
  : resultsSim;

  const progressEl = document.getElementById('progress');
  const floatEl = document.getElementById('progressFloating');
  resultsBox.innerHTML = "";
  progressEl.textContent = "";

  // ğŸ”„ æ¤œç´¢ã”ã¨ã«é‡è¤‡åˆ¤å®šã‚’åˆæœŸåŒ–
  const shownCombos = new Set();

  if(armors.length===0){
    resultsBox.innerHTML = cardHTML("ãƒ‡ãƒ¼ã‚¿æœªèª­è¾¼", "CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
    return;
  }

  // æ¡ä»¶å–å¾—ï¼ˆLvç©ºæ¬„/0ã¯é™¤å¤–ï¼‰
  const conds = [];
  for(let i=0;i<8;i++){
    const sEl = document.getElementById(`s_${i}`);
    const lEl = document.getElementById(`lv_${i}`);
    const s = (sEl?.value || "").trim();
    const lv = parseInt(lEl?.value || "",10);
    if(s && !isNaN(lv) && lv>0 && !lEl.disabled){
      conds.push({skill:s, level:Math.min(5, Math.max(1,lv))});
    }
  }

  // ãƒ­ãƒƒã‚¯ã‚ªãƒ³ONæ™‚ã¯è‡ªå‹•ä»˜ä¸ï¼ˆå…¥åŠ›ãŒç©ºã§ã‚‚å‹•ä½œï¼‰
  if (rockOnEnabled) {
    const idx = conds.findIndex(c => c.skill === "ãƒ­ãƒƒã‚¯ã‚ªãƒ³");
    if (idx === -1) conds.push({ skill: "ãƒ­ãƒƒã‚¯ã‚ªãƒ³", level: 1 });
    else conds[idx].level = Math.max(1, conds[idx].level || 1);
  }

  // å…¥åŠ›ãŒå®Œå…¨ã«ç©ºã§ãƒ­ãƒƒã‚¯ã‚ªãƒ³OFFã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
  if (conds.length === 0) {
    resultsBox.innerHTML = cardHTML("æ¡ä»¶ä¸è¶³", "ã‚¹ã‚­ãƒ«åã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ãƒ­ãƒƒã‚¯ã‚ªãƒ³ã‚’ONã«ã—ã¦ã­ã€‚");
    return;
  }

  // æ¡ä»¶ã‚¹ã‚­ãƒ«ã‚’å«ã‚€é˜²å…·ã ã‘æŠ½å‡ºï¼ˆäº‹å‰çµã‚Šè¾¼ã¿ï¼‰
  const byPart = { "é ­":[], "èƒ´":[], "è…•":[], "è…°":[], "è„š":[] };
  for(const a of armors){
    if(!byPart[a.part]) continue;
    const hasRelevant =
      conds.some(c => a.normal.some(s=>s.name===c.skill)) ||
      (driftEnabled && conds.some(c => a.drift.includes(c.skill)));
    if(hasRelevant) byPart[a.part].push(a);
  }

  const hasAnyHit = Object.values(byPart).some(arr => arr.length > 0);
  if(!hasAnyHit){
    resultsBox.innerHTML = cardHTML("å€™è£œä¸è¶³", "æ¡ä»¶ã‚¹ã‚­ãƒ«ã‚’å«ã‚€é˜²å…·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
    return;
  }

  // å®Ÿåœ¨éƒ¨ä½ã®ã¿ã§çµ„åˆã›ã‚’å›ã™
  const activeParts = Object.entries(byPart).filter(([_, arr]) => arr.length > 0);
  function* generateCombos(parts, index=0, current={}) {
    if(index >= parts.length){ yield current; return; }
    const [part, items] = parts[index];
    for(const item of items){
      yield* generateCombos(parts, index+1, {...current, [part]: item});
    }
  }

  const totalLoops = activeParts.reduce((acc, [_, arr]) => acc * arr.length, 1);
  let checked = 0;
  floatEl.style.display = "block";
  floatEl.textContent = `æ¢ç´¢ä¸­â€¦ 0%ï¼ˆ0 / ${totalLoops.toLocaleString()}ï¼‰`;

  const MAX_OUT = 10;
  const hits = [];

// ===== å˜ä¸€ã‚¹ã‚­ãƒ«æ¤œç´¢æ™‚ã¯å˜ç´”ãƒªã‚¹ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ =====
if (conds.length === 1) {
  const target = conds[0].skill;
  const targetLv = conds[0].level;
  const hits = [];
  for (const a of armors) {
    const hasNormal = a.normal.some(s => s.name === target && s.lv >= targetLv);
    const hasDrift = driftEnabled && a.drift.includes(target);
    if (hasNormal || hasDrift) {
      const normalStr = a.normal.map(s=>`${s.name}Lv${s.lv}`).join(", ");
      const driftStr  = a.drift.length ? a.drift.join(", ") : "â€”";
      const html =
        `<h3>${escapeHTML(a.part)}ï¼š${escapeHTML(a.name)}</h3>`+
        `<p class="equip">${escapeHTML(a.monster||"")}</p>`+
        `<div class="hr"></div>`+
        `<ul class="sumAll"><li class="badge hilite">${escapeHTML(target)} Lv${targetLv}</li></ul>`+
        `<p class="drifts">é€šå¸¸ï¼š${escapeHTML(normalStr)}<br>éŒ¬æˆï¼š${escapeHTML(driftStr)}</p>`;
      hits.push(html);
      if(hits.length>=MAX_OUT) break;
    }
  }

  resultsBox.innerHTML = hits.length ?
    hits.map(h=>`<div class="card">${h}</div>`).join("") :
    cardHTML("çµæœ 0ä»¶", "è©²å½“ã‚¹ã‚­ãƒ«ã‚’æŒã¤é˜²å…·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
  progressEl.textContent = `æ¢ç´¢å®Œäº†ï¼š${hits.length}ä»¶`;
  floatEl.textContent = `æ¢ç´¢å®Œäº†ï¼š${hits.length}ä»¶`;
  return;
}


  outer:
  for(const combo of generateCombos(activeParts)){
    const itemsByPart = {
      "é ­": combo["é ­"] || {},
      "èƒ´": combo["èƒ´"] || {},
      "è…•": combo["è…•"] || {},
      "è…°": combo["è…°"] || {},
      "è„š": combo["è„š"] || {},
    };

    checked++;
    if(checked % 500 === 0 || checked === totalLoops){
      const pct = Math.floor(checked/totalLoops*100);
      const msg = `æ¢ç´¢ä¸­â€¦ ${pct}%ï¼ˆ${checked.toLocaleString()} / ${totalLoops.toLocaleString()}ï¼‰`;
      progressEl.textContent = msg;
      floatEl.textContent = msg;
    }

    // åˆè¨ˆã‚¹ã‚­ãƒ«é›†è¨ˆï¼ˆæ¡ä»¶ã«é–¢ä¿‚ã™ã‚‹éƒ¨ä½ã®ã¿ï¼‰
    const totalMap = {};
    const contribByPart = { "é ­":{}, "èƒ´":{}, "è…•":{}, "è…°":{}, "è„š":{} };
    const condNames = new Set(conds.map(c=>c.skill));
    const usedParts = new Set();

    for (const p of PARTS) {
      const item = itemsByPart[p];
      if(!item.normal && !item.drift) continue;
      const relevant = conds.some(c =>
        item.normal?.some(s => s.name === c.skill) ||
        (driftEnabled && item.drift?.includes(c.skill))
      );
      if(relevant) usedParts.add(p);
    }

    for (const p of PARTS) {
      const item = itemsByPart[p];
      if (!usedParts.has(p)) continue;
      for (const { name, lv } of (item.normal || [])) {
        totalMap[name] = (totalMap[name] || 0) + lv;
        if (condNames.has(name)) {
          contribByPart[p][name] = (contribByPart[p][name] || 0) + lv;
        }
      }
      if (driftEnabled) {
        for (const ds of (item.drift || [])) {
          if (condNames.has(ds)) {
            totalMap[ds] = (totalMap[ds] || 0) + 1;
            contribByPart[p][ds] = (contribByPart[p][ds] || 0) + 1;
          }
        }
      }
    }

    // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
    const ok = conds.every(c => (totalMap[c.skill]||0) >= c.level);
    if(!ok) continue;

    // // è¡¨ç¤ºå¯¾è±¡éƒ¨ä½ã®æ±ºå®š
const shownParts = new Set();
if (conds.length === 1) {
  // å˜ä¸€ã‚¹ã‚­ãƒ«æ¤œç´¢ï¼šãã®ã‚¹ã‚­ãƒ«ã‚’æŒã¤ã™ã¹ã¦ã®éƒ¨ä½ã‚’è¡¨ç¤º
  const target = conds[0].skill;
  for (const p of PARTS) {
    const item = itemsByPart[p];
    const hit = item.normal?.some(s => s.name === target) ||
                (driftEnabled && item.drift?.includes(target));
    if (hit) shownParts.add(p); // breakãªã—ï¼
  }
  if (shownParts.size === 0) continue;
} else {
  // è¤‡æ•°ã‚¹ã‚­ãƒ«æ™‚ï¼šæ¡ä»¶é”æˆã«å¯„ä¸ã—ãŸéƒ¨ä½ã®ã¿
  const remaining = {}; conds.forEach(c => remaining[c.skill] = c.level);
  for(const p of PARTS){
    const contrib = contribByPart[p]; if(!contrib) continue;
    let contributes = false;
    for(const [sk, val] of Object.entries(contrib)){
      if((remaining[sk]||0) > 0 && val > 0){ contributes = true; break; }
    }
    if(contributes){
      shownParts.add(p);
      for(const [sk, val] of Object.entries(contrib)){
        if(remaining[sk] > 0) remaining[sk] = Math.max(0, remaining[sk] - val);
      }
    }
    if(Object.values(remaining).every(v=>v===0)) break;
  }
}

    // è£…å‚™ãƒ†ã‚­ã‚¹ãƒˆ
    const eqParts = {};
    for (const p of PARTS) {
      eqParts[p] = shownParts.has(p) ? (itemsByPart[p].name || "") : "";
    }
    const equipText =
      `é ­ï¼š${eqParts["é ­"]}\nèƒ´ï¼š${eqParts["èƒ´"]}\nè…•ï¼š${eqParts["è…•"]}\nè…°ï¼š${eqParts["è…°"]}\nè„šï¼š${eqParts["è„š"]}`;

    // è¡¨ç¤ºã‚¹ã‚­ãƒ«ï¼ˆè¡¨ç¤ºä¸­ã®éƒ¨ä½ã®ã¿ï¼‰
    let displaySkills = {};
    const usedDriftSetDisplay = new Set();
    for (const p of PARTS) {
      if (!shownParts.has(p)) continue;
      const item = itemsByPart[p];
      for (const { name, lv } of (item.normal || [])) {
        displaySkills[name] = (displaySkills[name] || 0) + lv;
      }
      if (driftEnabled) {
        for (const ds of (item.drift || [])) {
          usedDriftSetDisplay.add(ds);
          displaySkills[ds] = (displaySkills[ds] || 0) + 1;
        }
      }
    }

    const allSkills = Object.entries(displaySkills)
      .sort((a,b)=> (b[1]-a[1]) || a[0].localeCompare(b[0]));
    const allSkillBadges = allSkills.map(([name,lv])=>{
      const cls = condNames.has(name) ? "badge hilite" : "badge";
      return `<li class="${cls}">${escapeHTML(name)} Lv${lv}</li>`;
    }).join("");

    const driftText = driftEnabled
      ? (usedDriftSetDisplay.size ? `ä½¿ç”¨éŒ¬æˆã‚¹ã‚­ãƒ«ï¼š${[...usedDriftSetDisplay].sort().map(escapeHTML).join(", ")}` : `ä½¿ç”¨éŒ¬æˆã‚¹ã‚­ãƒ«ï¼šãªã—`)
      : `ä½¿ç”¨éŒ¬æˆã‚¹ã‚­ãƒ«ï¼šOFF`;

    const html =
      `<h3>#${hits.length+1}</h3>`+
      `<p class="equip">${escapeHTML(equipText)}</p>`+
      `<div class="hr"></div>`+
      `<ul class="sumAll">${allSkillBadges}</ul>`+
      `<p class="drifts">${driftText}</p>`;

// ===== é‡è¤‡é˜²æ­¢ï¼šåŒã˜é˜²å…·ã¯1å›ã—ã‹å‡ºã•ãªã„ =====
const comboKey =
  PARTS.map(p => shownParts.has(p) ? (itemsByPart[p]?.name || "") : "").join("|") + "|" +
  Object.entries(displaySkills).sort().map(([n,l]) => `${n}:${l}`).join(",") + "|" +
  [...usedDriftSetDisplay].sort().join(",");

// è¦‹ãŸç›®ãŒå®Œå…¨ã«åŒã˜å ´åˆã ã‘ã‚¹ã‚­ãƒƒãƒ—
if (shownCombos.has(comboKey)) continue;
shownCombos.add(comboKey);

    hits.push(html);
    if(hits.length >= MAX_OUT) break outer;
  }

  // è¡¨ç¤º
  resultsBox.innerHTML = "";
  if(hits.length===0){
    resultsBox.innerHTML = cardHTML("çµæœ 0ä»¶", "æ¡ä»¶ã«åˆã†çµ„ã¿åˆã‚ã›ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
  }else{
    hits.forEach(x=>{
      const div=document.createElement('div');
      div.className='card';
      div.innerHTML = x;
      resultsBox.appendChild(div);
    });
  }

  const finalMsg = `æ¢ç´¢å®Œäº†ï¼š${checked.toLocaleString()} / ${totalLoops.toLocaleString()}ï¼ˆãƒ’ãƒƒãƒˆ ${hits.length}ä»¶ï¼‰`;
  progressEl.textContent = finalMsg;
  floatEl.textContent = finalMsg;
}

/* ====== ä¸€è¦§ã‚¿ãƒ–ï¼šæ§‹ç¯‰ï¼†ãƒ•ã‚£ãƒ«ã‚¿ ====== */
function buildListTable(){
  const body = document.getElementById('listBody');
  const countEl = document.getElementById('listCount');
  const fltPart = document.getElementById('flt-part');
  const fltSkill = document.getElementById('flt-skill');

  function render(){
    const kw = (fltSkill.value||"").trim();
    const part = fltPart.value||"";
    const rx = kw ? new RegExp(escapeRegExp(kw), 'i') : null;

    const list = armors.filter(a=>{
      if(part && a.part!==part) return false;

      if(listDriftOnly){
        // éŒ¬æˆã®ã¿
        if(rx){
          return a.drift.length>0 && rx.test(a.drift.join(", "));
        }else{
          return a.drift.length>0;
        }
      }else{
        // é€šå¸¸ãƒ•ã‚£ãƒ«ã‚¿
        if(!rx) return true;
        const normalStr = a.normal.map(s=>`${s.name}Lv${s.lv}`).join(", ");
        const driftStr  = a.drift.join(", ");
        return rx.test(a.name) || rx.test(a.monster||"") || rx.test(normalStr) || rx.test(driftStr);
      }
    });

    body.innerHTML = list.map(a=>{
      const normalStr = a.normal.map(s=>`${escapeHTML(s.name)}Lv${s.lv}`).join(", ");
      const driftStr  = a.drift.length ? a.drift.map(escapeHTML).join(", ") : "â€”";
      return `<tr>
        <td>${escapeHTML(a.part)}</td>
        <td>${escapeHTML(a.monster||"")}</td>
        <td>${escapeHTML(a.name)}</td>
        <td class="td-skills">${normalStr||"â€”"}</td>
        <td class="td-skills">${driftStr}</td>
      </tr>`;
    }).join("");

    countEl.textContent = `${list.length} ä»¶è¡¨ç¤ºï¼ˆç·è¨ˆ ${armors.length}ï¼‰` + (listDriftOnly ? "ï¼ˆéŒ¬æˆã®ã¿ï¼‰" : "");
  }

  fltPart.addEventListener('change', render);
  fltSkill.addEventListener('input', render);
  render();
}

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function cardHTML(title, body){
  return `<div class="card"><h3>${escapeHTML(title)}</h3><div class="hr"></div><div class="equip">${escapeHTML(body)}</div></div>`;
}
function escapeHTML(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function escapeRegExp(s){
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}
</script>
</body>
</html>

